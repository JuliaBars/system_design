# Алгоритмы ограничения

## Маркерная корзина (Amazon, Stripe)

Через какой-то интервал в корзину помещаются маркеры, если она еще не заполнена,
Приходящий запрос берет маркер из корзины, если маркеров для него нет, запрос не обрабатывается

Особенности:

- для каждой нагруженной ручки может быть отдельная корзина
- либо для каждого ip
- либо общая корзина, если система выдерживает ограниченное число RPS

Преимущества:

- простая логика и реализация
- не занимает много памяти
- не страдает от всплеска трафика

Недостатки:

- сложно подобрать эффективный размер корзины и частоту

## Алгоритм дырявого ведра (Shopify)

Все запросы попадают в очередь, если она заполнена, то запрос отклоняется

Преимущества:

- эффективное потребление памяти
- постоянная заданная скорость обработки, устанавливаемая как скорость "утечки из ведра"

Недостатки:

- всплеск трафика забивает очередь и когда до запроса доходит его очередь, возможно он уже никому не нужен, при этом новые актуальные запросы некуда добавить (ведро заполнено)
- сложно подобрать эффективный размер очереди и скорость утечки

## Счетчик фиксированных интервалов

Разбиваем время на интервалы и на каждом интервале ставим предельный счетчик, новый запрос внутри интервала увеличивает счетчик на 1

Преимущества:

- легкая реализация, эффективен по памяти

Недостатки:

- всплеск трафика на границе интервалов может переполнить квоту

## Журнал скользящих интервалов

Каждый новый запрос добавляется в журнал ограниченного размера, если места хватило, запрос проходит.
Если нет, запрос отклоняется, но его время сохраняется в журнале.
Когда приходит следующий запрос, проверяем, что на момент его прихода минус допустимый интервал не превышен лимит запросов.
При этом все метки, время прихода которых старше этого промежутка,  удаляются.

Преимущества:

- не допускает ошибок на границе интервала как счетчик фиксированных интервалов

Недостатки:

- большое потребление памяти, тк даже отклоненные запросы записываются в журнал

## Счетчик скользящих интервалов

Тут возможность принять запрос вычисляется по формуле количество запросов на текущем интервале + запросы на предыдущем * 30% (это процент перекрытия интервалов)

Преимущества:

- экономия памяти, тк мы больше не храним метки отклоненных запросов
- нет риска допустить превышение лимита на границе интервалов

Недостатки:

- запросы могут быть распределены не равномерно и попасть в те 30% (но исследования Cloudflare показали что на 400М запросов 0.003% были приняты сверх квоты или ошибочно отклонены)
