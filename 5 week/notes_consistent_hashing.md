# Согласованное хеширование

Когда несколько серверов хранят кеш, нужно понять на какой конкретно сервер положить кеш

Можно захешировать данные клиента и распределять по кеш-серверам взятием остатка

server_index = hash(key) % N, где N - количество серверов с кешем

Проблемы начинаются когда N меняется, тогда server_index будет ошибочный и получится много непопаданий в кеш.

## Алгоритм согласованного хеширования

Все кеширующие сервера расположены на кольце, для хеша выбирается функция, которая производит равномерно распределённый диапазон значений хешей (SHA-256 и другие)

Имена серверов попадают на кольце по той же самой хеширующей функции (берем хеш или от их ip адреса или от имени). Ключ попадает на кольцо, и ближайший по часовой стрелке к нему сервер и будет его кеширующим сервером.

Добавление сервера:

- взять все ключи, которые идут против часовой стрелки от нового до ближайшего сервера
- перенести их на новый сервер

Удаление сервера:

- взять все ключи, которые идут от удаляемого сервера до ближайшего против часовой
- перенести на следующий по часовой стрелке сервер

Проблемы:

- интервалы, за которые отвечает каждый сервер могут быть неравномерными
- ключи также могут распределяться неравномерно

Решение:

- добавить для каждого сервера виртуальные сервера ("10.0.0.1#node-0", "10.0.0.1#node-1"  и тд)

Практика показала что при добавлении 100 виртуальных узлов для каждого сервера делает 10% стандартного отклонение от среднего, при 200 виртуальных серверах оно уже снижается до 5%

Минусы виртуальных серверов:

- место для хранения информации о них нужно тем больше, чем их больше
- поиск по огромным кольцам не бесплатный и занимает время [история Discord](https://discord.com/blog/how-discord-scaled-elixir-to-5-000-000-concurrent-users#:~:text=Fast%20Access%20Shared%20Data)

Плюсы согласованного хеширования:

- только K/n ключей должны быть переопределены
- нет горячих отрезков, куда попало сразу несколько кешей знаменитостей благодаря равномерному распределению ключей
- легко горизонтально масштабировать, добавляя сервера
